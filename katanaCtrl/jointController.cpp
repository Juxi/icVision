#include "jointController.h"
#include <iostream>
#include <cstdio>

JointController::JointController( ) : 
	pos(NULL), enc(NULL)
{
		
}

JointController::~JointController()
{
	//printf("Deleting %s %s\n", robotName.toStdString().c_str(), partName.toStdString().c_str());
	stop();
}

void JointController::start( const char* _robotName, const char* _partName )
{
	if ( !network.checkNetwork() ) { std::cout << "Cannot find YARP network." << std::endl; exit(1); }
	
	robotName = _robotName;
	partName = _partName;
	
	
///////////////////////
// for not using rpc

	yarp::os::Property options;
	options.put( "robot", robotName.c_str() ); // typically from the command line.
	options.put( "device", "remote_controlboard" );
	
	std::string localPort = "/" + robotName + "/csv_controller";
	options.put("local", localPort.c_str());
	
	std::string remotePort = "/" + robotName + "/" + partName;
	options.put("remote", remotePort.c_str());
	
	dd = new yarp::dev::PolyDriver(options);
	
	if ( dd )
	{
		dd->view(pos);
		dd->view(vel);
		dd->view(enc);
//		dd->view(posRaw);
//		dd->view(pid);
//		dd->view(amp);
//		dd->view(lim);
	}
	
	checkValidity();
	
	printf("yarp::dev::PolyDriver passed validity check\n");

	int numJoints;
	pos->getAxes(&numJoints);
	if ( numJoints != 6 )
	{
		std::string err = "Wrong number of DOFs: JointController must connect to an arm of the iCub robot, which has 6 joints. The requested device does not have the right number of joints!";
		//err.append(remotePort); err.append(" has "); err.append(numJoints);	err.append(" joints.");
		throw err;
	}
	
//	printf("Fluuuuf A\n");
//	for (int i = 7; i < 16; i++)
//	{
////		pos->setRefAcceleration(i, refAccel);
////		pos->setRefSpeed(i, refSpeed );
////		lim->getLimits(i, &(limits[i-7].min), &(limits[i-7].max));
//		amp->enableAmp(i);
//		pid->enablePid(i);
//	}

 /////////////////////////
 /*
	
	
	// connect to rpc	
	// check whether we have F or not!! TODO
	std::string clientPortName = "/katanaCtrl/rpc:o";
	if(! katanaPort.open( clientPortName.c_str() )){
		exit(1);
	}
	
	std::string remotePort = "/" + robotName + "/" + partName + "/rpc:i";

	
	// trying to connect to the rpc server (world interface)
	printf("Trying to connect to %s\n", remotePort.c_str());
	if(! network.connect(clientPortName.c_str(), remotePort.c_str()) ) {
		std::cout << "katanaCtrl" << ": Unable to connect to port "; 
		std::cout << remotePort.c_str() << std::endl;
		exit(1);
	}	
	*/
	printf("JointController started successfully.\n");
}

void JointController::checkValidity()
{
	if ( !dd ) { throw std::string("yarp::dev::PolyDriver was not created"); }
	else if ( !dd->isValid() ) { throw std::string("yarp::dev::PolyDriver is invalid"); }
	if (!pos) { throw std::string("IPositionControl Error!"); }
	if (!vel) { throw std::string("IVelocityControl Error!"); }
	if (!enc) { throw std::string("IEncoders Error!"); }
//	if (!pid) { throw std::string("IPidControl Error!"); }
//	if (!amp) { throw std::string("IAmplifierControl Error!"); }
//	if (!lim) { throw std::string("IControlLimits Error!"); }
}

void JointController::stop()
{
	checkValidity();
	
	/* this just closes the driver: OK */
	if (dd)
	{ 
		dd->close();
		delete dd;
	}
}





void JointController::loadPositions( const char* fileName ) {
	CtrlPoint *tgt = NULL;
	nextTarget = 0;

//	// raw positions
//	double array[][19] = {
//		{10,405.411750078201,3.72043834067881,143.696308135986,1.57997298240662,1.47436547279358,-0.0133627215400338,405.411750078201,3.72043834067881,143.696308135986,1.57997298240662,1.47436547279358,-0.0133627215400338,6271,-22998,-30905,19862,6500,12240},
//		{11,419.082969427109,-1.60571467131376,77.0522654056549,1.56696486473083,1.65086889266968,-0.0133627215400338,419.102966785431,-1.60579138901085,77.0786628127098,1.56696486473083,1.65080261230469,-0.0133627215400338,6377,-21164,-30893,19400,6500,12240},
//		{12,418.903052806854,-5.15236984938383,15.1972724124789,1.55849730968475,1.824835896492,-0.0133627215400338,418.936252593994,-5.15277869999409,15.2574768289924,1.55849730968475,1.82464706897736,-0.0133627215400338,6446,-19874,-30864,18645,6500,12240},
//		{13,402.887612581253,-5.2520832978189,-59.393011033535,1.5577609539032,2.05299091339111,-0.0133627215400338,402.916043996811,-5.2524539642036,-59.3719892203808,1.5577609539032,2.05292463302612,-0.0133627215400338,6452,-18546,-30772,17403,6500,12240},
//		{14,385.816633701324,-4.98218927532434,-115.316018462181,1.55788373947144,2.23420286178589,-0.0133627215400338,385.809004306793,-4.98209102079272,-115.341551601887,1.55788373947144,2.23426914215088,-0.0133627215400338,6451,-17037,-30416,16356,6500,12240},
//		{15,348.049908876419,-3.93915455788374,-175.455793738365,1.5594789981842,2.47655081748962,-0.0133627215400338,348.07288646698,-3.93941486254334,-175.466015934944,1.5594789981842,2.47655081748962,-0.0133627215400338,6438,-15634,-29885,14565,6500,12240},
//		{16,295.133233070374,-4.8617203719914,-217.756599187851,1.55432486534119,2.69941091537476,-0.0133627215400338,295.118808746338,-4.86148335039616,-217.776134610176,1.55432486534119,2.69947719573975,-0.0133627215400338,6480,-14896,-29785,13039,6500,12240},
//		{17,241.031318902969,-0.213610255741514,-237.360224127769,1.56991004943848,2.8901526927948,-0.0133627215400338,241.069465875626,-0.21364405984059,-237.355604767799,1.56991004943848,2.89008665084839,-0.0133627215400338,6353,-14891,-29780,11482,6500,12240},
//		{18,231.297209858894,54.7129921615124,-240.650877356529,1.80307519435883,2.91342973709106,-0.0133627215400338,231.297209858894,54.7129921615124,-240.650877356529,1.80307519435883,2.91342973709106,-0.0133627215400338,4453,-14593,-29620,11281,6500,12240},
//		{19,194.440603256226,116.600900888443,-252.703815698624,2.11097574234009,2.96119809150696,-0.0133627215400338,194.411918520927,116.583704948425,-252.733826637268,2.11097574234009,2.96133041381836,-0.0133627215400338,1944,-13758,-29590,11309,6500,12240},
//		{20,179.888471961021,174.314558506012,-247.386679053307,2.34045934677124,2.88669586181641,-0.0133627215400338,179.888471961021,174.314558506012,-247.386679053307,2.34045934677124,2.88669586181641,-0.0133627215400338,74,-13709,-29487,11832,6500,12240},
//		{21,221.535727381706,230.341672897339,-243.120297789574,2.37567949295044,2.76228523254395,-0.0133627215400338,221.524566411972,230.33007979393,-243.141442537308,2.37567949295044,2.76235151290894,-0.0133627215400338,-213,-11559,-27654,12028,6500,12240},
//		{22,277.189940214157,225.316405296326,-247.909009456635,2.25332927703857,2.72919273376465,-0.0133627215400338,277.215957641602,225.33755004406,-247.903779149055,2.25332927703857,2.72912645339966,-0.0133627215400338,784,-9540,-25926,11523,6500,12240},
//		{23,318.381011486053,172.636404633522,-245.935261249542,2.06765627861023,2.75744104385376,-0.0133627215400338,318.440139293671,172.668486833572,-245.916277170181,2.06765627861023,2.75725221633911,-0.0133627215400338,2297,-9082,-24982,10523,6500,12240},
//		{24,351.9526720047,109.684266149998,-239.119574427605,1.8729020357132,2.75239014625549,-0.0133627215400338,351.9526720047,109.684266149998,-239.119574427605,1.8729020357132,2.75239014625549,-0.0133627215400338,3884,-9081,-24545,10093,6500,12240},
//		{25,364.933669567108,53.5277910530567,-239.059284329414,1.71643590927124,2.75171995162964,-0.0133627215400338,364.949315786362,53.5300858318806,-239.034876227379,1.71643590927124,2.75165367126465,-0.0133627215400338,5159,-9081,-24545,10099,6500,12240},
//		{26,369.372248649597,-3.22847533971071,-239.034041762352,1.56205606460571,2.74896669387817,-0.0133627215400338,369.372248649597,-3.22847533971071,-239.034041762352,1.56205606460571,2.74896669387817,-0.0133627215400338,6417,-9080,-24565,10143,6500,12240},
//		{27,355.513244867325,-58.5560277104378,-244.50495839119,1.40755355358124,2.77381229400635,-0.0133627215400338,355.513244867325,-58.5560277104378,-244.50495839119,1.40755355358124,2.77381229400635,-0.0133627215400338,7676,-9080,-24750,10140,6500,12240},
//		{28,302.556425333023,-116.974346339703,-254.486262798309,1.20187747478485,2.8910174369812,-0.0133627215400338,302.572131156921,-116.980418562889,-254.46480512619,1.20187747478485,2.89095115661621,-0.0133627215400338,9352,-9256,-24896,9248,6500,12240},
//		{29,248.703315854073,-128.541469573975,-231.192603707314,1.09376239776611,2.95201730728149,-0.0133627215400338,248.73049557209,-128.555506467819,-231.155559420586,1.09376239776611,2.95188474655151,-0.0133627215400338,10233,-12267,-26274,8614,6500,12240},
//		{30,193.987429141998,-144.58142220974,-232.676774263382,0.930301427841187,3.01458048820496,-0.0133627215400338,193.999782204628,-144.590616226196,-232.660755515099,0.930301427841187,3.01451444625854,-0.0133627215400338,11565,-13522,-27431,8674,6500,12240},
//		{31,164.453774690628,-198.454111814499,-231.162637472153,0.691982209682465,2.9581995010376,-0.0133627215400338,164.463520050049,-198.465883731842,-231.145590543747,0.691982209682465,2.95813322067261,-0.0133627215400338,13507,-13525,-27516,9224,6500,12240},
//		{32,133.957371115685,-259.060740470886,-242.889732122421,0.477224916219711,2.8665452003479,-0.0133627215400338,133.949995040894,-259.046465158463,-242.909029126167,0.477224916219711,2.86661148071289,-0.0133627215400338,15257,-12095,-27405,10621,6500,12240},
//		{33,181.375101208687,-309.823453426361,-246.712550520897,0.529625713825226,2.79752635955811,-0.0133627215400338,181.421250104904,-309.815108776093,-246.731817722321,0.529748380184174,2.79752635955811,-0.0133627215400338,14830,-8744,-24342,9688,6500,12240},
//		{34,235.709980130196,-312.753319740295,-249.198824167252,0.645840048789978,2.79127407073975,-0.0133627215400338,235.690131783485,-312.726974487305,-249.250635504723,0.645840048789978,2.79140639305115,-0.0133627215400338,13883,-6332,-21756,8250,6500,12240},
//		{35,283.3072245121,-253.827661275864,-249.110832810402,0.840226113796234,2.85217976570129,-0.0133627215400338,283.3072245121,-253.827661275864,-249.110832810402,0.840226113796234,2.85217976570129,-0.0133627215400338,12299,-6015,-21037,7151,6500,12240},
//		{36,318.702608346939,-203.310951590538,-249.801218509674,1.00295078754425,2.86027908325195,-0.0133627215400338,318.702608346939,-203.310951590538,-249.801218509674,1.00295078754425,2.86027908325195,-0.0133627215400338,10973,-6014,-21037,7085,6500,12240},
//		{37,360.056400299072,-145.694971084595,-246.616899967194,1.18629217147827,2.82438850402832,-0.0133627215400338,360.041260719299,-145.688846707344,-246.642604470253,1.18629217147827,2.82445478439331,-0.0133627215400338,9479,-6012,-21037,7378,6500,12240},
//		{38,391.841799020767,-78.5032957792282,-243.901148438454,1.3730696439743,2.78499341011047,-0.0133627215400338,391.857624053955,-78.5064622759819,-243.874713778496,1.3730696439743,2.78492712974548,-0.0133627215400338,7957,-5971,-21060,7747,6500,12240},
//		{39,410.432666540146,-18.0039573460817,-243.252456188202,1.52695858478546,2.74296522140503,-0.0133627215400338,410.432666540146,-18.0039573460817,-243.252456188202,1.52695858478546,2.74296522140503,-0.0133627215400338,6703,-5868,-21182,8276,6500,12240},
//		{40,417.081445455551,45.9829308092594,-246.84152007103,1.68060219287872,2.713947057724,-0.0133627215400338,417.06520318985,45.9811389446259,-246.869280934334,1.68060219287872,2.71401309967041,-0.0133627215400338,5451,-5505,-21187,8713,6500,12240},
//		{41,421.382546424866,114.764831960201,-243.066921830177,1.83670008182526,2.65219068527222,-0.0133627215400338,421.382546424866,114.764831960201,-243.066921830177,1.83670008182526,2.65219068527222,-0.0133627215400338,4179,-5279,-21192,9344,6500,12240},
//		{42,420.221626758575,164.934307336807,-234.879642724991,1.9448150396347,2.59603452682495,-0.0133627215400338,420.207142829895,164.928629994392,-234.909504652023,1.9448150396347,2.59610056877136,-0.0133627215400338,3298,-5275,-21202,9814,6500,12240},
//		{43,423.966318368912,218.371674418449,-217.856496572495,2.04642581939697,2.4934458732605,-0.0133627215400338,423.966318368912,218.371674418449,-217.856496572495,2.04642581939697,2.4934458732605,-0.0133627215400338,2470,-5276,-21228,10678,6500,12240},
//		{44,465.899646282196,250.558018684387,-163.137376308441,2.06421995162964,2.25358629226685,-0.0133627215400338,465.888500213623,250.55205821991,-163.131192326546,2.06421995162964,2.25364255905151,-0.0133627215400338,2325,-5469,-21188,12486,6500,12240},
//		{45,491.327583789825,238.368958234787,-107.175402343273,2.02249574661255,2.14221096038818,-0.0133627215400338,491.340339183807,238.375142216682,-107.103139162064,2.02249574661255,2.14207863807678,-0.0133627215400338,2665,-6813,-21035,12504,6500,12240},
//		{46,520.775973796844,184.304624795914,-65.0864169001579,1.91094470024109,2.06915378570557,-0.0133627215400338,520.780026912689,184.306055307388,-65.04987180233,1.91094470024109,2.06908774375916,-0.0133627215400338,3574,-7971,-20983,12419,6500,12240},
//		{47,529.632449150085,114.828154444695,-48.0880029499531,1.78429925441742,2.09081053733826,-0.0133627215400338,529.635548591614,114.828824996948,-48.0521470308304,1.78429925441742,2.09074425697327,-0.0133627215400338,4606,-9183,-20981,11587,6500,12240},
//		{48,530.009984970093,45.4306416213512,-35.133995115757,1.65630388259888,2.10921001434326,-0.0133627215400338,530.012309551239,45.4308390617371,-35.0987985730171,1.65630388259888,2.10914373397827,-0.0133627215400338,5649,-10157,-20981,10912,6500,12240},
//		{49,525.16508102417,-25.6202220916748,-19.8192428797483,1.52204990386963,2.10549473762512,-0.0133627215400338,525.166392326355,-25.6202854216099,-19.7844561189413,1.52204990386963,2.10542845726013,-0.0133627215400338,6743,-10958,-20975,10504,6500,12240},
//		{50,519.515335559845,-90.5531197786331,-6.74642296507955,1.39822697639465,2.08007550239563,-0.0133627215400338,519.515335559845,-90.5531197786331,-6.74642296507955,1.39822697639465,2.08007550239563,-0.0133627215400338,7752,-11215,-20872,10461,6500,12240},
//		{51,498.893439769745,-159.547030925751,-7.38312350586057,1.26127314567566,2.10378932952881,-0.0133627215400338,498.875468969345,-159.54127907753,-7.41508277133107,1.26127314567566,2.10391187667847,-0.0133627215400338,8868,-11215,-20568,9939,6500,12240},
//		{52,467.675656080246,-226.358607411385,-11.7730246856809,1.12002420425415,2.13013458251953,-0.0133627215400338,467.675656080246,-226.358607411385,-11.7730246856809,1.12002420425415,2.13013458251953,-0.0133627215400338,10019,-11215,-20436,9583,6500,12240},
//		{53,426.236629486084,-290.682256221771,-17.5272393971682,0.972271144390106,2.15249824523926,-0.0133627215400338,426.236629486084,-290.682256221771,-17.5272393971682,0.972271144390106,2.15249824523926,-0.0133627215400338,11223,-11215,-20439,9404,6500,12240},
//		{54,360.382676124573,-358.285576105118,-29.0557462722063,0.788316190242767,2.19766998291016,-0.0133627215400338,360.365867614746,-358.268857002258,-29.1194748133421,0.788316190242767,2.19785904884338,-0.0133627215400338,12722,-11212,-20452,9051,6500,12240},
//		{55,299.603015184402,-396.618068218231,-44.0610609948635,0.646944522857666,2.25831532478333,-0.0133627215400338,299.615502357483,-396.634578704834,-44.0651848912239,0.646944522857666,2.25825881958008,-0.0133627215400338,13874,-11203,-20469,8580,6500,12240},
//		{56,248.195439577103,-431.339174509048,-43.3215983211994,0.522139847278595,2.25523781776428,-0.0133627215400338,248.195439577103,-431.339174509048,-43.3215983211994,0.522139847278595,2.25523781776428,-0.0133627215400338,14891,-11204,-20468,8604,6500,12240},
//		{57,211.603492498398,-494.340628385544,26.9020423293114,0.4044528901577,2.00294828414917,-0.0133627215400338,211.603492498398,-494.340628385544,26.9020423293114,0.4044528901577,2.00294828414917,-0.0133627215400338,15850,-11204,-20163,10330,6500,12240},
//		{58,217.141777276993,-511.611998081207,89.2351940274239,0.401384919881821,1.81407046318054,-0.0133627215400338,217.144593596458,-511.618673801422,89.2923101782799,0.401384919881821,1.81393814086914,-0.0133627215400338,15875,-11204,-19700,11372,6500,12240},
//		{59,251.419246196747,-502.740144729614,144.948363304138,0.46372589468956,1.65708613395691,-0.0133627215400338,251.419246196747,-502.740144729614,144.948363304138,0.46372589468956,1.65708613395691,-0.0133627215400338,15367,-11204,-19212,12124,6500,12240},
//		{60,317.401558160782,-464.367777109146,173.907473683357,0.599575161933899,1.57298457622528,-0.0133627215400338,317.401558160782,-464.367777109146,173.907473683357,0.599575161933899,1.57298457622528,-0.0133627215400338,14260,-11204,-19016,12598,6500,12240},
//		{61,391.296625137329,-403.610497713089,188.564017415047,0.769908428192139,1.5246239900589,-0.0133627215400338,391.296625137329,-403.610497713089,188.564017415047,0.769908428192139,1.5246239900589,-0.0133627215400338,12872,-11204,-19015,12991,6500,12240},
//		{62,445.097744464874,-343.177616596222,190.902128815651,0.913979887962341,1.51689267158508,-0.0133627215400338,445.097744464874,-343.177616596222,190.902128815651,0.913979887962341,1.51689267158508,-0.0133627215400338,11698,-11204,-19015,13054,6500,12240},
//		{63,487.336695194244,-279.974639415741,190.902128815651,1.04933834075928,1.51689267158508,-0.0133627215400338,487.336695194244,-279.974639415741,190.902128815651,1.04933834075928,1.51689267158508,-0.0133627215400338,10595,-11204,-19015,13054,6500,12240},
//		{64,517.648577690125,-218.912839889526,190.902128815651,1.17070698738098,1.51689267158508,-0.0133627215400338,517.648577690125,-218.912839889526,190.902128815651,1.17070698738098,1.51689267158508,-0.0133627215400338,9606,-11204,-19015,13054,6500,12240},
//		{65,542.237818241119,-147.854775190353,190.902128815651,1.30459272861481,1.51689267158508,-0.0133627215400338,542.237818241119,-147.854775190353,190.902128815651,1.30459272861481,1.51689267158508,-0.0133627215400338,8515,-11204,-19015,13054,6500,12240},
//		{66,556.694269180298,-77.2940963506699,190.902128815651,1.43283355236053,1.51689267158508,-0.0133627215400338,556.694269180298,-77.2940963506699,190.902128815651,1.43283355236053,1.51689267158508,-0.0133627215400338,7470,-11204,-19015,13054,6500,12240},
//		{67,561.923205852509,-11.1880181357265,190.902128815651,1.55088877677917,1.51689267158508,-0.0133627215400338,561.923205852509,-11.1880181357265,190.902128815651,1.55088877677917,1.51689267158508,-0.0133627215400338,6508,-11204,-19015,13054,6500,12240},
//		{68,559.471189975739,53.9094805717468,190.436005592346,1.66685771942139,1.51837491989136,-0.0133627215400338,559.471189975739,53.9094805717468,190.436005592346,1.66685771942139,1.51837491989136,-0.0133627215400338,5563,-11204,-19016,13043,6500,12240},
//		{69,550.476968288422,113.700918853283,189.768016338348,1.77448177337646,1.52058386802673,-0.0133627215400338,550.476968288422,113.700918853283,189.768016338348,1.77448177337646,1.52058386802673,-0.0133627215400338,4686,-11204,-19016,13025,6500,12240},
//		{70,531.484425067902,184.213474392891,180.89185655117,1.9044406414032,1.54843521118164,-0.0133627215400338,531.484425067902,184.213474392891,180.89185655117,1.9044406414032,1.54843521118164,-0.0133627215400338,3627,-11204,-19041,12825,6500,12240},
//		{71,503.530323505402,250.965267419815,172.327592968941,2.0331723690033,1.57624638080597,-0.0133627215400338,503.530323505402,250.965267419815,172.327592968941,2.0331723690033,1.57624638080597,-0.0133627215400338,2578,-11204,-19049,12606,6500,12240},
//		{72,472.191363573074,305.282562971115,159.371748566628,2.14472341537476,1.61875510215759,-0.0133627215400338,472.191363573074,305.282562971115,159.371748566628,2.14472341537476,1.61875510215759,-0.0133627215400338,1669,-11204,-19054,12266,6500,12240},
//		{73,422.315418720245,370.646059513092,152.748167514801,2.29112648963928,1.64060854911804,-0.0133627215400338,422.315418720245,370.646059513092,152.748167514801,2.29112648963928,1.64060854911804,-0.0133627215400338,476,-11204,-19055,12089,6500,12240},
//		{74,371.571391820908,421.44188284874,152.118071913719,2.41899919509888,1.64269471168518,-0.0133627215400338,371.571391820908,421.44188284874,152.118071913719,2.41899919509888,1.64269471168518,-0.0133627215400338,-566,-11204,-19055,12072,6500,12240},
//		{75,313.853979110718,465.965300798416,151.430130004883,2.54883527755737,1.64491319656372,-0.0133627215400338,313.852429389954,465.963006019592,151.393085718155,2.54883527755737,1.64503586292267,-0.0133627215400338,-1624,-11204,-19056,12055,6500,12240},
//		{76,258.434921503067,498.821258544922,150.459617376328,2.66357707977295,1.64747309684753,-0.0133627215400338,258.436232805252,498.823761940002,150.496691465378,2.66357707977295,1.6473503112793,-0.0133627215400338,-2559,-11204,-19067,12045,6500,12240},
//		{77,219.171658158302,511.944174766541,232.320964336395,2.73708534240723,1.37094473838806,-0.0133627215400338,219.16851401329,511.936843395233,232.321381568909,2.73708534240723,1.37100124359131,-0.0133627215400338,-3158,-11215,-19157,14390,6500,12240},
//		{78,235.986307263374,484.078228473663,287.006944417953,2.68799805641174,1.2370343208313,-0.0133627215400338,235.986307263374,484.078228473663,287.006944417953,2.68799805641174,1.2370343208313,-0.0133627215400338,-2758,-11702,-18746,14776,6500,12240},
//		{79,248.095795512199,438.549757003784,352.583914995193,2.6267614364624,1.09724581241608,-0.0133627215400338,248.084306716919,438.529461622238,352.617233991623,2.6267614364624,1.09717965126038,-0.0133627215400338,-2259,-12806,-18228,14762,6500,12240},
//		{80,252.292901277542,380.282342433929,417.241036891937,2.55583024024963,0.954490482807159,-0.0133627215400338,252.292901277542,380.282342433929,417.241036891937,2.55583024024963,0.954490482807159,-0.0133627215400338,-1681,-14198,-17776,14687,6500,12240},
//		{81,271.529823541641,313.203632831573,461.520940065384,2.42734408378601,0.846560060977936,-0.0133627215400338,271.509796380997,313.180565834045,461.548358201981,2.42734408378601,0.846493899822235,-0.0133627215400338,-634,-15312,-17501,14670,6500,12240},
//		{82,312.796145677567,255.664795637131,472.115129232407,2.25602912902832,0.816922426223755,-0.0133627215400338,312.771946191788,255.645006895065,472.141861915588,2.25602912902832,0.816856265068054,-0.0133627215400338,762,-15470,-17356,14670,6500,12240},
//		{83,349.928617477417,195.618629455566,475.435793399811,2.08054161071777,0.806611716747284,-0.0133627215400338,349.928617477417,195.618629455566,475.435793399811,2.08054161071777,0.806611716747284,-0.0133627215400338,2192,-15469,-17279,14671,6500,12240},
//		{84,378.110498189926,131.938010454178,475.880324840546,1.90652680397034,0.804638743400574,-0.0133627215400338,378.09693813324,131.933286786079,475.896090269089,1.90652680397034,0.80462908744812,-0.0133627215400338,3610,-15469,-17277,14687,6500,12240},
//		{85,392.843037843704,69.7936713695526,477.401435375214,1.74662470817566,0.797643721103668,-0.0133627215400338,392.817467451096,69.7891265153885,477.428048849106,1.74662470817566,0.797520935535431,-0.0133627215400338,4913,-15469,-17278,14744,6500,12240},
//		{86,398.772865533829,13.3048938587308,477.401435375214,1.60414850711823,0.797643780708313,-0.0133627215400338,398.772865533829,13.3048938587308,477.401435375214,1.60414850711823,0.797643780708313,-0.0133627215400338,6074,-15469,-17278,14743,6500,12240},
//		{87,395.830392837524,-48.6840158700943,477.587521076202,1.44841885566711,0.79678475856781,-0.0133627215400338,395.862132310867,-48.638604581356,477.560967206955,1.44854152202606,0.796907365322113,-0.0133627215400338,7342,-15469,-17278,14751,6500,12240},
//		{88,377.139717340469,-126.606732606888,478.594988584518,1.246915102005,0.792121410369873,-0.0133627215400338,377.139717340469,-126.606732606888,478.594988584518,1.246915102005,0.792121410369873,-0.0133627215400338,8985,-15469,-17278,14788,6500,12240},
//		{89,343.596905469894,-199.420318007469,479.149758815765,1.04492056369781,0.789544343948364,-0.0133627215400338,343.619525432587,-199.433445930481,479.123383760452,1.04492056369781,0.789667010307312,-0.0133627215400338,10631,-15469,-17278,14808,6500,12240},
//		{90,302.544832229614,-258.155167102814,478.696495294571,0.864401638507843,0.791206836700439,-0.0133627215400338,302.544832229614,-258.155167102814,478.696495294571,0.864401638507843,0.791206836700439,-0.0133627215400338,12102,-15469,-17285,14803,6500,12240},
//		{91,255.650371313095,-308.582425117493,475.541323423386,0.691859483718872,0.801167488098145,-0.0133627215400338,255.650371313095,-308.582425117493,475.541323423386,0.691859483718872,0.801167488098145,-0.0133627215400338,13508,-15467,-17357,14800,6500,12240}
//	};
//		
//	std::cout << array[0][13] << ",";
//	std::cout << array[0][15] << std::endl;
//	std::cout << array[1][13] << ",";	
//	std::cout << array[0][13] << std::endl;
//	std::cout << array[0][14] << std::endl;	
//	std::cout << array[0][15] << std::endl;		
//	std::cout << array[0][16] << std::endl;		
//	std::cout << array[0][17] << std::endl;		
//	std::cout << array[0][18] << std::endl;		
//	std::cout << array[1][14] << std::endl;	
//	
//	for(int i = 0; i < 80; i++) {
//		tgt = new CtrlPoint();
//		tgt->pos[0] = array[i][13];
//		tgt->pos[1] = array[i][14];
//		tgt->pos[2] = array[i][15];
//		tgt->pos[3] = array[i][16];
//		tgt->pos[4] = array[i][17];
//		tgt->pos[5] = array[i][18];
//	
//		storedTargets.push_back(tgt);
//	}
	
	
	double array[][19] = {
		{10, 180.525781, 93.918969, 53.420182, 141.814063, 180.765625, 8.70625},
		{11, 179.780469, 86.967318, 53.511152, 145.0625, 180.765625, 8.70625},
		{12, 179.295313, 82.077662, 53.738578, 150.371094, 180.765625, 8.70625},
		{13, 179.253125, 77.040179, 54.428437, 159.103906, 180.765625, 8.70625},
		{14, 179.260156, 71.324209, 57.134805, 166.465625, 180.765625, 8.70625},
		{15, 179.351563, 66.002443, 61.160243, 179.065625, 180.765625, 8.70625},
		{16, 179.05625, 63.212686, 61.910748, 189.788281, 180.765625, 8.70625},
		{17, 179.949219, 63.193733, 61.948652, 200.735938, 180.765625, 8.70625},
		{18, 193.308594, 62.064185, 63.16159, 202.149219, 180.765625, 8.70625},
		{19, 210.957031, 58.899175, 63.389016, 201.952344, 180.765625, 8.70625},
		{20, 224.098438, 58.713444, 64.169845, 198.275, 180.765625, 8.70625},
		{21, 226.116406, 50.560226, 78.073147, 196.896875, 180.765625, 8.70625},
		{22, 219.10625, 42.911136, 91.172878, 200.447656, 180.765625, 8.70625},
		{23, 208.467969, 41.175118, 98.329212, 207.478906, 180.765625, 8.70625},
		{24, 197.309375, 41.163747, 101.642049, 210.502344, 180.765625, 8.70625},
		{25, 188.344531, 41.171328, 101.634468, 210.460156, 180.765625, 8.70625},
		{26, 179.499219, 41.159957, 101.482851, 210.150781, 180.765625, 8.70625},
		{27, 170.646875, 41.163747, 100.080391, 210.171875, 180.765625, 8.70625},
		{28, 158.8625, 41.827072, 98.973585, 216.44375, 180.765625, 8.70625},
		{29, 152.667969, 53.251432, 88.519576, 220.901563, 180.765625, 8.70625},
		{30, 143.309375, 57.997052, 79.756099, 220.479688, 180.765625, 8.70625},
		{31, 129.647656, 58.016004, 79.111725, 216.619531, 180.765625, 8.70625},
		{32, 117.342969, 52.584316, 79.953201, 206.796875, 180.765625, 8.70625},
		{33, 120.345313, 39.893952, 103.180964, 213.35, 180.765625, 8.70625},
		{34, 127.003906, 30.743851, 122.777493, 223.460938, 180.765625, 8.70625},
		{35, 138.141406, 29.546075, 128.235714, 231.188281, 180.765625, 8.70625},
		{36, 147.471875, 29.538494, 128.228134, 231.652344, 180.765625, 8.70625},
		{37, 157.969531, 29.530913, 128.228134, 229.592188, 180.765625, 8.70625},
		{38, 168.671094, 29.383087, 128.053774, 227.004688, 180.765625, 8.70625},
		{39, 177.488281, 28.992672, 127.128908, 223.285156, 180.765625, 8.70625},
		{40, 186.291406, 27.609165, 127.091004, 220.205469, 180.765625, 8.70625},
		{41, 195.235156, 26.756318, 127.0531, 215.76875, 180.765625, 8.70625},
		{42, 201.422656, 26.737366, 126.977291, 212.471094, 180.765625, 8.70625},
		{43, 207.258594, 26.748737, 126.780189, 206.389063, 180.765625, 8.70625},
		{44, 208.271094, 27.472709, 127.083423, 193.676563, 180.765625, 8.70625},
		{45, 205.880469, 32.582211, 128.243295, 193.55, 180.765625, 8.70625},
		{46, 199.489063, 36.97153, 128.645081, 194.147656, 180.765625, 8.70625},
		{47, 192.225781, 41.569323, 128.652662, 199.997656, 180.765625, 8.70625},
		{48, 184.899219, 45.257413, 128.660243, 204.74375, 180.765625, 8.70625},
		{49, 177.207031, 48.289758, 128.705728, 207.605469, 180.765625, 8.70625},
		{50, 170.1125, 49.260108, 129.478976, 207.914844, 180.765625, 8.70625},
		{51, 162.265625, 49.252527, 131.791139, 211.578125, 180.765625, 8.70625},
		{52, 154.172656, 49.260108, 132.791813, 214.088281, 180.765625, 8.70625},
		{53, 145.7, 49.252527, 132.761489, 215.346875, 180.765625, 8.70625},
		{54, 135.167188, 49.241156, 132.662938, 217.828906, 180.765625, 8.70625},
		{55, 127.060156, 49.207042, 132.534063, 221.140625, 180.765625, 8.70625},
		{56, 119.909375, 49.218413, 132.541644, 220.971875, 180.765625, 8.70625},
		{57, 113.173438, 49.210833, 134.853807, 208.842969, 180.765625, 8.70625},
		{58, 112.997656, 49.214623, 138.371328, 201.516406, 180.765625, 8.70625},
		{59, 116.569531, 49.214623, 142.070789, 196.214844, 180.765625, 8.70625},
		{60, 124.353125, 49.214623, 143.556638, 192.896094, 180.765625, 8.70625},
		{61, 134.1125, 49.214623, 143.556638, 190.132813, 180.765625, 8.70625},
		{62, 142.367188, 49.218413, 143.564218, 189.682813, 180.765625, 8.70625},
		{63, 150.129688, 49.214623, 143.556638, 189.682813, 180.765625, 8.70625},
		{64, 157.076563, 49.214623, 143.556638, 189.682813, 180.765625, 8.70625},
		{65, 164.747656, 49.214623, 143.556638, 189.682813, 180.765625, 8.70625},
		{66, 172.102344, 49.214623, 143.556638, 189.682813, 180.765625, 8.70625},
		{67, 178.866406, 49.218413, 143.556638, 189.682813, 180.765625, 8.70625},
		{68, 185.503906, 49.214623, 143.549057, 189.760156, 180.765625, 8.70625},
		{69, 191.670313, 49.214623, 143.549057, 189.879688, 180.765625, 8.70625},
		{70, 199.109375, 49.210833, 143.359535, 191.292969, 180.765625, 8.70625},
		{71, 206.492188, 49.218413, 143.298888, 192.825781, 180.765625, 8.70625},
		{72, 212.883594, 49.210833, 143.260984, 195.223438, 180.765625, 8.70625},
		{73, 221.271875, 49.218413, 143.253403, 196.467969, 180.765625, 8.70625},
		{74, 228.598438, 49.210833, 143.253403, 196.5875, 180.765625, 8.70625},
		{75, 236.0375, 49.218413, 143.253403, 196.707031, 180.765625, 8.70625},
		{76, 242.61875, 49.210833, 143.162433, 196.777344, 180.765625, 8.70625},
		{77, 246.823438, 49.252527, 142.480155, 180.282031, 180.765625, 8.70625},
		{78, 244.010938, 51.102258, 145.59589, 177.582031, 180.765625, 8.70625},
		{79, 240.502344, 55.294475, 149.522776, 177.680469, 180.765625, 8.70625},
		{80, 236.445313, 60.566965, 152.949326, 178.200781, 180.765625, 8.70625},
		{81, 229.076563, 64.789505, 155.041644, 178.327344, 180.765625, 8.70625},
		{82, 219.260938, 65.377022, 156.140869, 178.313281, 180.765625, 8.70625},
		{83, 209.20625, 65.380812, 156.717015, 178.313281, 180.765625, 8.70625},
		{84, 199.235938, 65.380812, 156.732177, 178.200781, 180.765625, 8.70625},
		{85, 190.074219, 65.380812, 156.724596, 177.8, 180.765625, 8.70625},
		{86, 181.910938, 65.380812, 156.724596, 177.8, 180.765625, 8.70625},
		{87, 172.995313, 65.380812, 156.724596, 177.757813, 180.765625, 8.70625},
		{88, 161.442969, 65.380812, 156.724596, 177.490625, 180.765625, 8.70625},
		{89, 149.869531, 65.380812, 156.724596, 177.35, 180.765625, 8.70625}
	};
	
		
	
	for(int i = 0; i < 80; i++) {
		tgt = new CtrlPoint();
		tgt->pos[0] = array[i][1];
		tgt->pos[1] = array[i][2];
		tgt->pos[2] = array[i][3];
		tgt->pos[3] = array[i][4];
		tgt->pos[4] = array[i][5];
		tgt->pos[5] = -120; //array[i][6];
	
		storedTargets.push_back(tgt);
	}
	
}

yarp::os::Bottle* JointController::getEncodersAsBottle() {
	double vals[KATANA_JOINT_NR];
	enc->getEncoders(vals);
	
	yarp::os::Bottle *b = new yarp::os::Bottle();
	for(int i = 0; i < KATANA_JOINT_NR; i++)
		b->addDouble(vals[i]);

	return b;
}


//void JointController::loadPositions( const char* fileName ) {
//	CtrlPoint *tgt = new CtrlPoint();
//	nextTarget = 0;
//	
//	tgt->pos[0] = 10.0;
//	tgt->pos[1] = 110;
//	tgt->pos[2] = 56.49;
//	tgt->pos[3] = 67.02;
//	tgt->pos[4] = 12.02;
//	tgt->pos[5] = -121.58;
//	
//	storedTargets.push_back(tgt);
//		
//}

void JointController::goToNext( )
{
//	double tgt[KATANA_JOINT_NR];
//	
//	tgt[0] = 10.0;
//	tgt[1] = 110;
//	tgt[2] = 56.49;
//	tgt[3] = 67.02;
//	tgt[4] = 12.02;
//	tgt[5] = -121.58;
	
	double *tgt = storedTargets[nextTarget]->pos;

	nextTarget++;
	if(nextTarget >= storedTargets.size())
		nextTarget = 0;
	
	
	blockingPositionMove(tgt);
}


void JointController::blockingPositionMove( double *target )
{
	bool ok;
//	for (int i = 0; i <= KATANA_JOINT_NR; i++ )
//	{
//		ok = pos->positionMove( i, target[i] );
//		if ( !ok ) { throw std::string("Position move failed"); }
//	}

	// RAW encoder moves!!
	ok = pos->positionMove( target );
	if ( !ok ) { throw std::string("Position move failed"); }

	
	bool finished = false;
	while ( !finished )
	{
		pos->checkMotionDone(&finished);
	}
	
//	yarp::os::Bottle cmd, response, posB;
//	
//	// get information about the object from rpc
//	cmd.clear();
//	cmd.addString("set");
//	cmd.addString("poss");
//	
//	posB.addDouble(target[0]);
//	posB.addDouble(target[1]);
//	posB.addDouble(target[2]);
//	posB.addDouble(target[3]);
//	posB.addDouble(target[4]);
//	posB.addDouble(target[5]);
//	
//	cmd.addList() = posB;
//	
//	katanaPort.write(cmd, response);
}
